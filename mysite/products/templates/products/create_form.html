{% extends "homepage/base.html" %}
{% load crispy_forms_tags %}
{% load static %}
{% block content %}
    <div class="content-section">

        <form method="POST" enctype='multipart/form-data'>
            {% csrf_token %}

            {% if form.errors %}
                {% for field in form %}
                    {% for error in field.errors %}
                        <div class="alert alert-danger">
                            <strong>{{ error|escape }}</strong>
                        </div>
                    {% endfor %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                    <div class="alert alert-danger">
                        <strong>{{ error|escape }}</strong>
                    </div>
                {% endfor %}
            {% endif %}

            <fieldset class="form-group">
                <legend class="border-bottom mb-4">New Product</legend>

              <!-- Container for croppie -->
              <div id="croppie-container" style="width: 300px; height: 300px; margin-top: 25px; margin-bottom: 25px; margin-left: auto; margin-right: auto; display: none">
              </div>

                {{ form|crispy }}
                <input id="cropped-dimensions-input" name="cropped-dimensions" style="display: none">

            </fieldset>
            <div class="form-group">
                <button class="btn btn-outline-info" type="submit">Upload</button>
            </div>
        </form>

        <script>
            let uploadedImage = document.getElementById('id_image');

            // Update the previewed image with the uploaded image
            function readFileAsync(file) {
              return new Promise((resolve, reject) => {
                let reader = new FileReader();

                reader.onload = () => {
                  console.log('FileReader loaded')
                  resolve(reader.result);
                };

                reader.onerror = reject;

                console.log('Starting to read file')
                reader.readAsDataURL(file);
              })
            }

            async function processFile() {
                  $('#croppie-container').css('display', 'none').croppie('destroy')  // destroy any existing croppies
                  try {
                    console.log('Processing uploaded file')
                    let file = uploadedImage.files[0];
                    let src = await readFileAsync(file);

                      // Start croppie with the uploaded image src
                      $('#croppie-container')
                      .css('display', 'block')  // make div container visible
                      .croppie({
                        viewport: {width: 200, height: 200},
                        boundary: {width: 250, height: 250}})
                      .croppie('bind', {url: src});


                  } catch(err) {
                    console.log(err);
                  }
                }

            uploadedImage.addEventListener("change", processFile);

        </script>

        <script>
            // get the cropped dimensions and store them as comma separated string in hidden form input
            function getCropDimensions() {
                let croppedDimensions = $('#croppie-container').croppie('get').points.join();
                $('#cropped-dimensions-input').val(croppedDimensions);
            }
            $('#croppie-container').on('update.croppie', getCropDimensions);
        </script>



        <script>
            // Hide sizes that are only applicable to the gender not selected
            $('#id_gender').on('change', function() {
                let selectedValue = $("#id_gender").val();
                let selectedGender = $("#id_gender").find("option").filter(function() {return $(this).val() === selectedValue;}).text()
                let menSizes = $("#id_size").find("option").filter(function () { return $(this).html().includes("Men"); });
                let womenSizes = $("#id_size").find("option").filter(function () { return $(this).html().includes("Women"); });
                if (selectedGender === 'Menswear'){
                    menSizes.show();
                    womenSizes.hide();
                } else if ((selectedGender === 'Womenswear')){
                    menSizes.hide();
                    womenSizes.show();
                } else {
                    // for Unisex
                    menSizes.show();
                    womenSizes.show();
                }
            })
        </script>
    </div>
{% endblock content %}